// Sensor de presión MPX5700AP
const int pressurePin = A0;
const float Vout_min = 0.2;
const float Vout_max = 4.7;
const float P_min = 0.0;
const float P_max = 700.0;

// Pines BTS7960
const int RPWM = 5;
const int LPWM = 6;
const int R_EN = 7;
const int L_EN = 8;

// Variables de control
unsigned long startTime = 0;
bool extending = false;
bool retracting = false;
unsigned long motorDuration = 10000; // Duración configurable (default 10 segundos)

// Buffer para comandos seriales
String inputString = "";
bool stringComplete = false;

void setup() {
  // Configurar pines del motor
  pinMode(RPWM, OUTPUT);
  pinMode(LPWM, OUTPUT);
  pinMode(R_EN, OUTPUT);
  pinMode(L_EN, OUTPUT);
  
  // Habilitar ambos lados del puente H
  digitalWrite(R_EN, HIGH);
  digitalWrite(L_EN, HIGH);
  
  // Inicializar comunicación serial
  Serial.begin(9600);
  Serial.println("Sistema listo. Envía 'E' para extender, 'R' para retraer, o 'T:valor' para cambiar tiempo.");
  Serial.print("Tiempo actual: ");
  Serial.print(motorDuration);
  Serial.println(" ms");
  
  // Reservar espacio para el string de entrada
  inputString.reserve(50);
}

void loop() {
  // Leer datos seriales
  while (Serial.available()) {
    char inChar = (char)Serial.read();
    
    // Comando simple de un solo carácter
    if (inChar == 'E' || inChar == 'e') {
      startExtension();
    }
    else if (inChar == 'R' || inChar == 'r') {
      startRetraction();
    }
    else if (inChar == '\n') {
      stringComplete = true;
    }
    else {
      inputString += inChar;
    }
  }
  
  // Procesar comando de tiempo si está completo
  if (stringComplete) {
    processCommand(inputString);
    inputString = "";
    stringComplete = false;
  }
  
  // Control del tiempo de operación
  if (extending || retracting) {
    unsigned long elapsedTime = millis() - startTime;
    
    // Leer y mostrar presión durante la operación
    int sensorValue = analogRead(pressurePin);
    float voltage = sensorValue * (5.0 / 1023.0);
    float pressure = ((voltage - Vout_min) * (P_max - P_min) /
                     (Vout_max - Vout_min)) + P_min;
    
    Serial.print("Pressure: ");
    Serial.print(pressure);
    Serial.println(" kPa");
    
    // Verificar si ha transcurrido el tiempo configurado
    if (elapsedTime >= motorDuration) {
      // Detener el motor
      analogWrite(RPWM, 0);
      analogWrite(LPWM, 0);
      
      if (extending) {
        Serial.println("Extension completada.");
        extending = false;
      }
      else if (retracting) {
        Serial.println("Retraccion completada.");
        retracting = false;
      }
    }
    
    delay(500); // Lectura del sensor cada 500ms
  }
}

void startExtension() {
  extending = true;
  retracting = false;
  startTime = millis();
  Serial.println("Extendiendo motor...");
  analogWrite(RPWM, 255);
  analogWrite(LPWM, 0);
}

void startRetraction() {
  retracting = true;
  extending = false;
  startTime = millis();
  Serial.println("Retrayendo motor...");
  analogWrite(RPWM, 0);
  analogWrite(LPWM, 255);
}

void processCommand(String command) {
  command.trim();
  
  // Comando para cambiar el tiempo: T:valor
  if (command.startsWith("T:") || command.startsWith("t:")) {
    int colonIndex = command.indexOf(':');
    if (colonIndex != -1) {
      String timeStr = command.substring(colonIndex + 1);
      long newTime = timeStr.toInt();
      
      if (newTime >= 1000 && newTime <= 60000) {
        motorDuration = newTime;
        Serial.print("Tiempo actualizado a: ");
        Serial.print(motorDuration);
        Serial.println(" ms");
      } else {
        Serial.println("Error: Tiempo debe estar entre 1000 y 60000 ms");
      }
    }
  }
}
